{% comment %}
AI Sales Assistant Widget Block
This creates a floating chat widget that can be added to any page
{% endcomment %}

{% schema %}
{
  "name": "AI Sales Assistant",
  "target": "body",
  "settings": [
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Enable AI Assistant",
      "default": true
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        },
        {
          "value": "bottom-left", 
          "label": "Bottom Left"
        },
        {
          "value": "top-right",
          "label": "Top Right"
        },
        {
          "value": "top-left",
          "label": "Top Left"
        },
        {
          "value": "center-right",
          "label": "Center Right"
        },
        {
          "value": "center-left",
          "label": "Center Left"
        }
      ],
      "default": "bottom-right"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Ask AI Assistant"
    },
    {
      "type": "text",
      "id": "chat_title",
      "label": "Chat Title",
      "default": "AI Sales Assistant"
    },
    {
      "type": "textarea",
      "id": "welcome_message",
      "label": "Welcome Message",
      "default": "Hello! I'm your AI sales assistant. I can help you find products, answer questions about pricing, shipping, and provide personalized recommendations. How can I assist you today?"
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input Placeholder",
      "default": "Ask me anything about our products..."
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#ee5cee"
    },
    {
      "type": "checkbox",
      "id": "gradient_enabled",
      "label": "Enable Gradient Background",
      "default": false
    },
    {
      "type": "color",
      "id": "gradient_color_1",
      "label": "Gradient Color 1",
      "default": "#ee5cee"
    },
    {
      "type": "color",
      "id": "gradient_color_2",
      "label": "Gradient Color 2",
      "default": "#31d1d1"
    },
    {
      "type": "select",
      "id": "gradient_direction",
      "label": "Gradient Direction",
      "options": [
        { "value": "to right", "label": "Left to Right" },
        { "value": "to left", "label": "Right to Left" },
        { "value": "to bottom", "label": "Top to Bottom" },
        { "value": "to top", "label": "Bottom to Top" }
      ],
      "default": "to right"
    },
    {
      "type": "checkbox",
      "id": "glass_effect",
      "label": "Enable Glass Effect",
      "default": false
    },
    {
      "type": "select",
      "id": "widget_style",
      "label": "Widget Style",
      "options": [
        { "value": "eye-animation", "label": "Eye Animation" },
        { "value": "simple", "label": "Simple Chat Icon" }
      ],
      "default": "eye-animation"
    },
    {
      "type": "checkbox",
      "id": "show_button_text",
      "label": "Show Button Text",
      "default": true,
      "info": "Toggle to show/hide the button text next to the icon"
    },
    {
      "type": "select",
      "id": "chat_background_color",
      "label": "Chat Background Color",
      "options": [
        { "value": "white", "label": "White Background" },
        { "value": "black", "label": "Black Background" }
      ],
      "default": "white",
      "info": "Choose the background color for the chat interface"
    }
  ]
}
{% endschema %}

<!-- AI Sales Assistant Widget will be dynamically loaded -->
<div id="ai-sales-assistant-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:99998; background:rgba(0,0,0,0); touch-action:none;"></div>
<div id="ai-sales-assistant-container"></div>

<script>
// AI Sales Assistant Widget JavaScript
(function() {
  let chatOpen = false;
  let conversationHistory = [];
  let widgetSettings = null;
  
  // Get settings from block settings or fetch from API
  const blockSettings = {
    enabled: {{ block.settings.enabled | json }},
    position: {{ block.settings.position | json }},
    buttonText: {{ block.settings.button_text | json }},
    chatTitle: {{ block.settings.chat_title | json }},
    welcomeMessage: {{ block.settings.welcome_message | json }},
    inputPlaceholder: {{ block.settings.input_placeholder | json }},
    primaryColor: {{ block.settings.primary_color | json }},
    gradientEnabled: {{ block.settings.gradient_enabled | json }},
    gradientColor1: {{ block.settings.gradient_color_1 | json }},
    gradientColor2: {{ block.settings.gradient_color_2 | json }},
    gradientDirection: {{ block.settings.gradient_direction | json }},
    glassEffect: {{ block.settings.glass_effect | json }},
    widgetStyle: {{ block.settings.widget_style | json }},
    showButtonText: {{ block.settings.show_button_text | json }},
    chatBackgroundColor: {{ block.settings.chat_background_color | json }}
  };
  
  // Start typewriter animation for welcome message
  function startWelcomeAnimation() {
    const welcomeText = document.getElementById('welcome-text');
    if (welcomeText && !welcomeText.classList.contains('animation-started')) {
      welcomeText.classList.add('animation-started');
      
      const fullText = welcomeText.textContent;
      welcomeText.textContent = '';
      
      let i = 0;
      const typingSpeed = 50; // milliseconds per character
      
      function type() {
        if (i < fullText.length) {
          welcomeText.textContent += fullText.charAt(i);
          i++;
          setTimeout(type, typingSpeed);
        } else {
          // Remove cursor after animation completes
          setTimeout(() => {
            welcomeText.classList.add('typing-complete');
          }, 1000); // Wait 1 second after typing finishes
        }
      }
      
      // Start typing with a small delay
      setTimeout(type, 300);
    }
  }

  // Toggle chat window
  window.toggleAIChat = function() {
    console.log('[AI Widget] toggleAIChat called, current state:', chatOpen);
    const chatWindow = document.getElementById('ai-chat-window');
    if (!chatWindow) {
      console.error('[AI Widget] Chat window not found!');
      return;
    }
    chatOpen = !chatOpen;
    if (chatOpen) {
      chatWindow.classList.add('ai-chat-open');
      chatWindow.style.display = 'grid'; // Ensure visible when open
      
      // Start welcome message animation with a slight delay
      setTimeout(() => {
        startWelcomeAnimation();
      }, 300);
    } else {
      chatWindow.classList.remove('ai-chat-open');
      chatWindow.style.display = 'none'; // Ensure hidden when closed
    }
    console.log('[AI Widget] Chat window toggled to:', chatOpen ? 'open' : 'closed');
    console.log('[AI Widget] Chat window classes:', chatWindow.className);
    console.log('[AI Widget] Chat window computed display:', window.getComputedStyle(chatWindow).display);
    
    if (chatOpen) {
      const inputField = document.getElementById('ai-chat-input-field');
      if (inputField) {
        // Wait for CSS transition to start before focusing
        setTimeout(() => inputField.focus(), 200);
      }
      // Ensure scroll starts at the top when chat opens
      setTimeout(() => {
        scrollToTop();
      }, 250);
    }
  };
  
  // Handle enter key press
  window.handleChatKeyPress = function(event) {
    if (event.key === 'Enter') {
      sendAIMessage();
    }
  };
  
  // Send message to AI
  window.sendAIMessage = function() {
    const inputField = document.getElementById('ai-chat-input-field');
    const message = inputField.value.trim();
    
    if (!message) return;
    
    // Hide welcome screen after first message
    hideWelcomeScreen();
    
    // Add user message to chat
    addMessageToChat('user', message);
    inputField.value = '';
    
    // Show loading
    showLoading(true);
    
    // Send to AI service using the app proxy (single endpoint for both settings and chat)
    const shopUrl = '{{ shop.url }}';
    
    // Function to send message via app proxy
    const sendChatMessage = async () => {
      console.log('🚀 Sending chat message via app proxy');
      try {
        const response = await fetch(`${shopUrl}/apps/widget-settings`, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-Shopify-Shop-Domain': '{{ shop.myshopify_domain }}',
             'X-Shopify-Customer-Access-Token': '{{ customer.access_token | default: "" }}',
           },
           body: JSON.stringify({
             userMessage: message,
             products: [],
             context: {
               page: window.location.pathname,
               productId: getProductIdFromPage(),
               conversationHistory: conversationHistory,
               shopDomain: '{{ shop.myshopify_domain }}'
             }
           })
         });
         
         if (response.ok) {
           console.log('✅ Success! Chat message sent via app proxy');
           return await response.json();
         } else {
           console.log(`❌ App proxy request failed with status: ${response.status}`);
           throw new Error(`Request failed with status ${response.status}`);
         }
       } catch (error) {
         console.log('❌ Failed to send chat message via app proxy:', error);
         throw error;
       }
     };
     
     // Send the chat message
     sendChatMessage()
      .then(data => {
      showLoading(false);
      
      // Handle both old format (data.response) and new N8N format (data.message)
      let responseMessage = data.response || data.message;
      
      if (responseMessage) {
        // Add the main AI response
        addMessageToChat('assistant', responseMessage);
        
        // If there are product recommendations, display them
        if (data.recommendations && data.recommendations.length > 0) {
          displayProductRecommendations(data.recommendations);
        }
        
        // Update conversation history
        conversationHistory.push(
          { role: 'user', content: message },
          { role: 'assistant', content: responseMessage }
        );
        
        // Keep only last 10 messages
        if (conversationHistory.length > 10) {
          conversationHistory = conversationHistory.slice(-10);
        }
      } else {
        addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
      }
    })
    .catch(error => {
      showLoading(false);
      console.error('AI Assistant Error:', error);
      addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
    });
  };
  
  // Add message to chat
  function addMessageToChat(sender, message) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `ai-message ${sender}-message`;
    
    // Force spacing with inline styles to override any CSS
    messageDiv.style.marginBottom = '0px';
    messageDiv.style.marginTop = '0px';
    messageDiv.style.display = 'block';
    // Remove margin-top for the first user message after welcome
    if (sender === 'user' && messagesContainer && messagesContainer.querySelectorAll('.ai-message.user-message').length === 0) {
      messageDiv.style.marginTop = '0px';
    }
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    
    // Trim whitespace and handle line breaks properly
    const cleanMessage = message.trim().replace(/\n/g, '<br>');
    messageContent.innerHTML = cleanMessage;
    
    // Apply proper styling for text wrapping
    messageContent.style.wordWrap = 'break-word';
    messageContent.style.wordBreak = 'break-word';
    messageContent.style.overflowWrap = 'break-word';
    messageContent.style.whiteSpace = 'normal'; // Normal whitespace handling
    messageContent.style.maxWidth = '100%';
    messageContent.style.boxSizing = 'border-box';
    
    if (sender === 'user') {
      if (widgetSettings.useDefaultAppearance) {
        messageContent.style.backgroundColor = 'rgba(255, 255, 255, 0.15)';
        messageContent.style.backdropFilter = 'blur(8px)';
        messageContent.style.border = '1px solid rgba(255, 255, 255, 0.2)';
        messageContent.style.color = 'white';
      } else {
        messageContent.style.backgroundColor = widgetSettings.primaryColor;
        messageContent.style.color = 'white';
      }
    } else {
      if (widgetSettings.useDefaultAppearance) {
        messageContent.style.backgroundColor = 'rgba(255, 255, 255, 0.08)';
        messageContent.style.backdropFilter = 'blur(6px)';
        messageContent.style.border = '1px solid rgba(255, 255, 255, 0.1)';
        messageContent.style.color = 'white';
      } else {
        messageContent.style.backgroundColor = '#f1f1f1';
        messageContent.style.color = '#333';
      }
    }
    
    messageDiv.appendChild(messageContent);
    // Remove welcome message if present BEFORE adding .has-messages
    const welcome = messagesContainer.querySelector('.ai-welcome-message');
    if (welcome) {
      welcome.style.marginBottom = '0px'; // Remove any bottom margin before removing
      welcome.remove();
    }
    messagesContainer.appendChild(messageDiv);
    // Add has-messages class for flex alignment
    messagesContainer.classList.add('has-messages');
    // Scroll to bottom with smooth animation
    scrollToBottom();
    setTimeout(observeImagesForScroll, 100);
  }
  
  // Smooth scroll to bottom function
  function scrollToBottom() {
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      // Use setTimeout to ensure the new message is rendered before scrolling
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 10);
    }
  }
  
  // Smooth scroll to top function
  function scrollToTop() {
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      // Use setTimeout to ensure the chat window is fully rendered before scrolling
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      }, 10);
    }
  }
  
  // Display enhanced product recommendations
  function displayProductRecommendations(recommendations) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    console.log('[AI Widget] displayProductRecommendations called, recommendations:', recommendations);
    
    // Add a container for all product cards
    const productsContainer = document.createElement('div');
    productsContainer.className = 'ai-message assistant-message products-grid-container';
    productsContainer.style.marginBottom = '16px';
    productsContainer.style.maxWidth = '100%';
    productsContainer.style.width = '100%';
    
    const gridContent = document.createElement('div');
    gridContent.className = 'products-grid';
    gridContent.style.display = 'grid';
    gridContent.style.gridTemplateColumns = recommendations.length === 1 ? '1fr' : 'repeat(auto-fit, minmax(280px, 1fr))';
    gridContent.style.gap = '12px';
    gridContent.style.padding = '0';
    gridContent.style.width = '100%';
    
    recommendations.forEach((product, index) => {
      // Create individual product card
      const productCard = document.createElement('div');
      productCard.className = 'product-card clickable-product';
      productCard.style.backgroundColor = '#fff';
      productCard.style.border = '1px solid #e5e7eb';
      productCard.style.borderRadius = '12px';
      productCard.style.overflow = 'hidden';
      productCard.style.cursor = 'pointer';
      productCard.style.transition = 'all 0.3s ease';
      productCard.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
      productCard.style.position = 'relative';
      
      // Product image (if available)
      let imageSection = '';
      if (product.image) {
        imageSection = `
          <div class="product-image" style="
            width: 100%; 
            height: 160px; 
            background-image: url('${product.image}'); 
            background-size: cover; 
            background-position: center;
            background-color: #f8f9fa;
            position: relative;
          ">
            <div style="
              position: absolute;
              top: 8px;
              right: 8px;
              background: ${widgetSettings.primaryColor};
              color: white;
              padding: 4px 8px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: 600;
            ">${product.relevanceScore || 85}% match</div>
          </div>
        `;
      }
      
      // Product details
      const productDetails = `
        <div style="padding: 16px;">
          <!-- Product Title -->
          <h4 style="
            margin: 0 0 8px 0; 
            font-size: 16px; 
            font-weight: 600; 
            color: #1f2937;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
          ">${product.title}</h4>
          
          <!-- Price and Category -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-size: 20px; font-weight: 700; color: ${widgetSettings.primaryColor};">
              $${parseFloat(product.price || '0').toFixed(2)}
            </div>
            ${product.category ? `<div style="
              background: #f3f4f6; 
              color: #6b7280; 
              padding: 2px 8px; 
              border-radius: 8px; 
              font-size: 11px; 
              font-weight: 500;
            ">${product.category}</div>` : ''}
          </div>
          
          <!-- Description -->
          <p style="
            margin: 0 0 12px 0; 
            font-size: 13px; 
            color: #6b7280; 
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
          ">${product.description || 'No description available'}</p>
          
          <!-- Tags (if available) -->
          ${product.tags && product.tags.length > 0 ? `
            <div style="margin-bottom: 12px;">
              ${product.tags.slice(0, 3).map(tag => `
                <span style="
                  display: inline-block;
                  background: #e5e7eb;
                  color: #374151;
                  padding: 2px 6px;
                  border-radius: 6px;
                  font-size: 10px;
                  margin-right: 4px;
                  margin-bottom: 4px;
                ">${tag}</span>
              `).join('')}
            </div>
          ` : ''}
          
          <!-- Action Button -->
          <div style="
            background: ${widgetSettings.primaryColor};
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-top: auto;
          ">
            View Product →
          </div>
        </div>
      `;
      
      productCard.innerHTML = imageSection + productDetails;
      
      // Add click handler to open product page
      productCard.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Use full URL if available, otherwise construct relative URL
        const productUrl = product.fullUrl || `/products/${product.handle}`;
        window.open(productUrl, '_blank');
        
        // Add visual feedback
        this.style.transform = 'scale(0.98)';
        setTimeout(() => {
          this.style.transform = 'scale(1)';
        }, 150);
      });
      
      // Add hover effects
      productCard.addEventListener('mouseenter', function() {
        this.style.borderColor = widgetSettings.primaryColor;
        this.style.transform = 'translateY(-4px)';
        this.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.15)';
      });
      
      productCard.addEventListener('mouseleave', function() {
        this.style.borderColor = '#e5e7eb';
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
      });
      
      gridContent.appendChild(productCard);
    });
    
    productsContainer.appendChild(gridContent);
    messagesContainer.appendChild(productsContainer);
    
    // Add a "Browse More Products" button if there are multiple recommendations
    if (recommendations.length > 2) {
      const browseMoreDiv = document.createElement('div');
      browseMoreDiv.className = 'ai-message assistant-message';
      browseMoreDiv.style.marginTop = '8px';
      browseMoreDiv.style.textAlign = 'center';
      
      const browseButton = document.createElement('button');
      browseButton.style.background = 'transparent';
      browseButton.style.border = `2px solid ${widgetSettings.primaryColor}`;
      browseButton.style.color = widgetSettings.primaryColor;
      browseButton.style.padding = '10px 20px';
      browseButton.style.borderRadius = '25px';
      browseButton.style.fontSize = '14px';
      browseButton.style.fontWeight = '600';
      browseButton.style.cursor = 'pointer';
      browseButton.style.transition = 'all 0.2s ease';
      browseButton.textContent = 'Browse All Products';
      
      browseButton.addEventListener('click', function() {
        window.open('/collections/all', '_blank');
      });
      
      browseButton.addEventListener('mouseenter', function() {
        this.style.backgroundColor = widgetSettings.primaryColor;
        this.style.color = 'white';
      });
      
      browseButton.addEventListener('mouseleave', function() {
        this.style.backgroundColor = 'transparent';
        this.style.color = widgetSettings.primaryColor;
      });
      
      browseMoreDiv.appendChild(browseButton);
      messagesContainer.appendChild(browseMoreDiv);
    }
    
    // Scroll to bottom after adding recommendations
    setTimeout(scrollToBottom, 100);
    setTimeout(observeImagesForScroll, 200);
    // --- Fireworks Animation Trigger ---
    if (typeof window.triggerFireworksAnimation === 'function') {
      window.triggerFireworksAnimation();
    } else {
      triggerFireworksAnimation();
    }
  }
  
  // Show/hide loading indicator
  function showLoading(show) {
    const messagesContainer = document.getElementById('ai-chat-messages');
    let loadingDiv = document.getElementById('ai-loading');
    
    if (show) {
      // Remove any existing loading indicator first
      if (loadingDiv) {
        loadingDiv.remove();
      }
      
      // Create new loading indicator
      loadingDiv = document.createElement('div');
      loadingDiv.id = 'ai-loading';
      loadingDiv.className = 'ai-loading';
      
      // Apply default appearance styling if enabled
      if (widgetSettings.useDefaultAppearance) {
        loadingDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.08)';
        loadingDiv.style.backdropFilter = 'blur(6px)';
        loadingDiv.style.border = '1px solid rgba(255, 255, 255, 0.1)';
        loadingDiv.style.color = 'white';
      }
      
      const loadingDots = document.createElement('div');
      loadingDots.className = 'loading-dots';
      
      // Create the three dots
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('span');
        loadingDots.appendChild(dot);
      }
      
      loadingDiv.appendChild(loadingDots);
      
      // Find the last actual message (excluding welcome message) and insert loading after it
      if (messagesContainer) {
        // Get all message elements, excluding the welcome message
        const allMessages = messagesContainer.querySelectorAll('.ai-message:not(.ai-welcome-message)');
        
        if (allMessages.length > 0) {
          // Insert after the last actual message
          const lastMessage = allMessages[allMessages.length - 1];
          lastMessage.insertAdjacentElement('afterend', loadingDiv);
        } else {
          // If no actual messages yet, append to container
          messagesContainer.appendChild(loadingDiv);
        }
        
        // Auto-scroll to show the loading indicator
        scrollToBottom();
      }
    } else {
      // Hide/remove loading indicator
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }
  }
  
  // Hide welcome screen after first interaction
  function hideWelcomeScreen() {
    const welcomeMessage = document.querySelector('.ai-welcome-message');
    if (welcomeMessage) {
      welcomeMessage.style.display = 'none';
      console.log('✅ AI Widget: Welcome screen hidden');
    }
    const messagesContainer = document.getElementById('ai-chat-messages');
    if (messagesContainer) {
      messagesContainer.classList.remove('welcome-active');
    }
  }
  
  // Get product ID from current page
  function getProductIdFromPage() {
    const productMatch = window.location.pathname.match(/\/products\/([^\/]+)/);
    if (productMatch) {
      return productMatch[1];
    }
    return null;
  }
  
  // Load widget settings and initialize
  async function initializeWidget() {
    try {
      // Use block settings or fetch from API as fallback
      widgetSettings = blockSettings;
      
      // Debug current context
      console.log('🏪 Current shop domain:', window.Shopify?.shop || '{{ shop.permanent_domain }}');
      console.log('🌐 Current location:', window.location.href);
      console.log('🔧 Block settings:', blockSettings);
      
      // Try to fetch updated settings from API
      const shopDomain = window.Shopify?.shop || '{{ shop.permanent_domain }}';
      // Use app proxy URL (proper way for theme extensions)
      const shopUrl = '{{ shop.url }}';
      const possibleSettingsUrls = [
        // Use app proxy URL - requests are forwarded to your app server
        shopUrl + '/apps/widget-settings',
        // Fallback to current host
        window.location.protocol + '//' + window.location.host + '/apps/widget-settings'
      ];
      
      let apiSuccess = false;
      for (const appUrl of possibleSettingsUrls) {
        try {
          console.log(`🔄 AI Widget: Trying to fetch settings from ${appUrl}`);
          const timestamp = Date.now();
          const response = await fetch(`${appUrl}?shop=${shopDomain}&t=${timestamp}`);
          if (response.ok) {
            const data = await response.json();
            console.log(`✅ AI Widget: Successfully fetched settings from ${appUrl}`, data.settings);
            
            // Prioritize API settings over block settings
            widgetSettings = { ...blockSettings, ...data.settings };
            apiSuccess = true;
            
            // Initialize lastSettingsUpdate with current timestamp for auto-refresh
            if (typeof window.lastSettingsUpdate === 'undefined') {
              window.lastSettingsUpdate = data.settings.updatedAt;
            }
            break;
          } else {
            console.log(`❌ AI Widget: Failed to fetch from ${appUrl} - Status: ${response.status}`);
          }
        } catch (e) {
          console.log(`❌ AI Widget: Error fetching from ${appUrl}:`, e);
          continue;
        }
      }
      
      if (!apiSuccess) {
        console.log('⚠️ AI Widget: Could not fetch settings from API, using block settings', blockSettings);
      }
      
      // Debug logging
      console.log('AI Widget: Settings loaded (updated):', widgetSettings);
      
      // Only create widget if enabled
      if (!widgetSettings.enabled) {
        console.log('AI Widget: Disabled, not creating widget');
        return;
      }
      
      // Create the widget HTML
      createWidget();
      
      // Add debugging to console to verify settings are applied
      console.log('AI Widget: Widget created with settings:', {
        position: widgetSettings.position,
        primaryColor: widgetSettings.primaryColor,
        buttonText: widgetSettings.buttonText,
        chatTitle: widgetSettings.chatTitle
      });
      
    } catch (error) {
      console.error('Failed to load AI Sales Assistant settings:', error);
      // Use block settings as fallback
      widgetSettings = blockSettings;
      if (widgetSettings.enabled) {
        createWidget();
      }
    }
  }
  
  // Create the widget HTML
  function createWidget() {
    const container = document.getElementById('ai-sales-assistant-container');
    if (!container || !widgetSettings) return;
    
    console.log('AI Widget: Creating widget with position:', widgetSettings.position);
    
    // Clear any existing widget
    container.innerHTML = '';
    
    function getWidgetBackgroundStyle() {
      if (widgetSettings.gradientEnabled) {
        return `linear-gradient(${widgetSettings.gradientDirection}, ${widgetSettings.gradientColor1}, ${widgetSettings.gradientColor2})`;
      }
      return widgetSettings.primaryColor;
    }
    
    function getCombinedStyle() {
      // Use default dark appearance if enabled
      if (widgetSettings.useDefaultAppearance) {
        return getUnifiedDefaultAppearanceStyle();
      }
      
      const baseBackground = getWidgetBackgroundStyle();
      let style = `background: ${baseBackground};`;
      
      if (widgetSettings.glassEffect) {
        // Create glass effect by overlaying transparent white on the base background
        style = `background: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0.05)), ${baseBackground}; backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.18);`;
      }
      
      return style;
    }
    
    function getUnifiedDefaultAppearanceStyle() {
      return `background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(12px); color: white;`;
    }
    
    
    function getChatWindowStyle() {
      if (widgetSettings.useDefaultAppearance) {
        return getUnifiedDefaultAppearanceStyle();
      }
      return `background: ${widgetSettings.chatBackgroundColor === 'black' ? '#1a1a1a' : 'white'}; color: ${widgetSettings.chatBackgroundColor === 'black' ? 'white' : 'black'}`;
    }
    
    function getChatMessagesContainerStyle() {
      if (widgetSettings.useDefaultAppearance) {
        return getUnifiedDefaultAppearanceStyle();
      }
      return `background: ${widgetSettings.chatBackgroundColor === 'black' ? '#1a1a1a' : 'white'}; color: ${widgetSettings.chatBackgroundColor === 'black' ? 'white' : 'black'}`;
    }
    
    function getChatMessagesStyle() {
      if (widgetSettings.useDefaultAppearance) {
        return `background: transparent; color: white;`;
      }
      return `background: ${widgetSettings.chatBackgroundColor === 'black' ? '#1a1a1a' : 'white'}; color: ${widgetSettings.chatBackgroundColor === 'black' ? 'white' : 'black'}`;
    }
    

    container.innerHTML = `
      <div class="ai-sales-assistant-widget position-${widgetSettings.position}" data-widget-id="ai-sales-assistant">
        <!-- Chat Toggle Button -->
        <button 
          class="ai-chat-toggle" 
          id="ai-chat-toggle-btn"
          style="${getCombinedStyle()}"
        >
          ${widgetSettings.widgetStyle === 'eye-animation' ? 
            '<img src="{{ "animationeyelogo.svg" | asset_url }}" alt="iHeard.ai" width="24" height="24" style="object-fit: contain;" />' :
            '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'
          }
          ${widgetSettings.showButtonText ? `<span class="button-text">${widgetSettings.buttonText}</span>` : ''}
        </button>
        
        <!-- Chat Window -->
        <div id="ai-chat-window" class="ai-chat-window" style="display: none; ${getChatWindowStyle()}">
          <!-- Chat Header -->
          <div class="ai-chat-header" style="${getCombinedStyle()}">
            <div class="ai-chat-header-rect">
              <div class="ai-chat-header-content">
                <h3>${widgetSettings.chatTitle}</h3>
                <div class="ai-chat-header-buttons">
                  <button class="ai-chat-call-btn" id="ai-chat-call-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Call
                  </button>
                  <button class="ai-chat-close" id="ai-chat-close-btn">
                    <svg width="16" height="16" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M13.5 4.5L4.5 13.5M4.5 4.5L13.5 13.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Fireworks Animation Overlay -->
          <div id="ai-fireworks-animation" style="display:none;"></div>
          <!-- Chat Messages Container -->
          <div class="ai-chat-messages-container" style="${getChatMessagesContainerStyle()}">
            <!-- Chat Messages -->
            <div id="ai-chat-messages" class="ai-chat-messages" style="${getChatMessagesStyle()}">
              <div class="ai-message assistant-message ai-welcome-message" style="margin-bottom: 16px !important; margin-top: 0px !important; display: block !important; max-width: 100% !important; width: 100% !important;">
                <div class="ai-welcome-container" style="background: transparent; padding: 0;">
                  <div class="ai-welcome-header" style="margin-bottom: 20px;">
                    <h3 id="welcome-text" class="typewriter" style="margin: 0; font-size: 18px; font-weight: 600; color: ${widgetSettings.useDefaultAppearance ? 'white' : (widgetSettings.chatBackgroundColor === 'black' ? 'white' : '#333')};">${widgetSettings.welcomeMessage}</h3>
                  </div>
                  <!-- All suggestion sections removed -->
                </div>
              </div>
              

            </div>
          </div>
          
          <!-- Chat Input -->
          <div class="ai-chat-input" style="${getCombinedStyle()}">
            <input 
              type="text" 
              id="ai-chat-input-field"
              placeholder="${widgetSettings.inputPlaceholder}"
              style="background: ${widgetSettings.useDefaultAppearance ? 'rgba(255, 255, 255, 0.1)' : 'white'}; color: ${widgetSettings.useDefaultAppearance ? 'white' : 'black'}; border: ${widgetSettings.useDefaultAppearance ? '1px solid rgba(255, 255, 255, 0.2)' : '1px solid #ddd'};"
            />
            <button id="ai-chat-send-btn">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 2L9 11M18 2L12 18L9 11M18 2L2 8L9 11" stroke="${widgetSettings.useDefaultAppearance ? 'white' : widgetSettings.primaryColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add CSS styles
    addWidgetStyles();
    
    // Add event listeners after DOM is ready
    setTimeout(() => {
      setupEventListeners();
      // Remove has-messages if only welcome message is present
      const messagesContainer = document.getElementById('ai-chat-messages');
      if (messagesContainer) messagesContainer.classList.remove('has-messages');
      // Add centering class for welcome message
      if (messagesContainer && messagesContainer.querySelector('.ai-welcome-message')) {
        messagesContainer.classList.add('welcome-active');
      }
    }, 50);
  }
  
  // Define border color function before CSS
  function getChatInputBorderColor() {
    return widgetSettings.chatBackgroundColor === 'black' ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
  }
  
  // Add CSS styles for the widget
  function addWidgetStyles() {
    if (document.getElementById('ai-widget-styles')) return;
    
    // Debug logging
    console.log('🎨 AI Widget: Adding styles with settings:', {
      useDefaultAppearance: widgetSettings.useDefaultAppearance,
      chatBackgroundColor: widgetSettings.chatBackgroundColor,
      primaryColor: widgetSettings.primaryColor
    });
    
    // Set CSS variables for dynamic theming
    document.documentElement.style.setProperty('--ai-primary-color', widgetSettings.primaryColor);
    document.documentElement.style.setProperty('--ai-primary-color-hover', widgetSettings.primaryColor + 'dd');
    
    const style = document.createElement('style');
    style.id = 'ai-widget-styles';
    style.textContent = `
#ai-sales-assistant-overlay {
  pointer-events: none !important;
  z-index: 99998 !important;
}
.ai-chat-window, .ai-chat-header, .ai-chat-close {
  pointer-events: auto !important;
  z-index: 10001 !important;
}
.ai-chat-close {
  position: relative;
  z-index: 10002 !important;
}
/* AI Sales Assistant Widget Styles */
.ai-sales-assistant-widget {
  position: fixed;
  z-index: 1000;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Position variants */
.ai-sales-assistant-widget.position-bottom-right {
  bottom: 20px;
  right: 20px;
}

.ai-sales-assistant-widget.position-bottom-left {
  bottom: 20px;
  left: 20px;
}

.ai-sales-assistant-widget.position-top-right {
  top: 20px;
  right: 20px;
}

.ai-sales-assistant-widget.position-top-left {
  top: 20px;
  left: 20px;
}

.ai-sales-assistant-widget.position-center-right {
  top: 50%;
  right: 20px;
  transform: translateY(-50%);
}

.ai-sales-assistant-widget.position-center-left {
  top: 50%;
  left: 20px;
  transform: translateY(-50%);
}

.ai-chat-toggle {
  background: var(--ai-primary-color, #ee5cee);
  border: none;
  border-radius: 50px;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

.ai-chat-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.ai-chat-toggle .button-text {
  white-space: nowrap;
}
@media (max-width: 480px) {
  .ai-chat-toggle .button-text {
    display: none !important;
  }
}

.ai-chat-window {
  position: absolute;
  bottom: 70px;
  right: 0;
  width: 420px;
  height: 600px;
  background: ${widgetSettings.useDefaultAppearance ? 'rgba(0, 0, 0, 0.2)' : 'white'};
  ${widgetSettings.useDefaultAppearance ? 'backdrop-filter: blur(12px);' : ''}
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
  display: none;
  grid-template-rows: 70px 1fr 70px;
  grid-template-areas: 
    "header"
    "messages"
    "input";
  overflow-x: hidden;
  overflow-y: visible;
  max-height: 600px;
  min-height: 600px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;
}

.ai-chat-window.ai-chat-open {
  display: grid !important;
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
}

.ai-sales-assistant-widget.position-bottom-left .ai-chat-window,
.ai-sales-assistant-widget.position-top-left .ai-chat-window,
.ai-sales-assistant-widget.position-center-left .ai-chat-window {
  right: auto;
  left: 0;
}

.ai-sales-assistant-widget.position-top-right .ai-chat-window,
.ai-sales-assistant-widget.position-top-left .ai-chat-window {
  bottom: auto;
  top: 70px;
}

.ai-sales-assistant-widget.position-center-right .ai-chat-window,
.ai-sales-assistant-widget.position-center-left .ai-chat-window {
  bottom: auto;
  top: 50%;
  transform: translateY(-50%);
}

.ai-chat-header {
  background: ${widgetSettings.useDefaultAppearance ? 'rgba(0, 0, 0, 0.2)' : 'var(--ai-primary-color, #ee5cee)'};
  ${widgetSettings.useDefaultAppearance ? 'backdrop-filter: blur(12px);' : ''}
  border: none;
  color: white;
  padding: 0;
  z-index: 10;
  height: 70px;
  box-sizing: border-box;
  grid-area: header !important;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: visible;
}

.ai-chat-header-rect {
  background: rgba(0, 0, 0, 0.8) !important;
  border-radius: 25px;
  padding: 8px 16px;
  margin: 8px 16px;
  width: calc(100% - 32px);
  height: auto;
  max-width: 400px;
  backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
  position: relative;
  overflow: visible;
}

.ai-chat-header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  width: 100%;
  flex: 1;
}

.ai-chat-header h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: white;
}

.ai-chat-header-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
}

.ai-chat-call-btn {
  background: rgba(74, 144, 226, 0.9);
  border: none;
  color: white;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.ai-chat-call-btn:hover {
  background: rgba(74, 144, 226, 1);
  transform: translateY(-1px);
}

.ai-chat-call-btn svg {
  width: 14px;
  height: 14px;
}

.ai-chat-close {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.ai-chat-close svg {
  width: 16px;
  height: 16px;
}

.ai-chat-close:hover {
  background: rgba(255, 255, 255, 0.1);
}

.ai-chat-messages-container {
  grid-area: messages !important;
  overflow: hidden;
  background: ${widgetSettings.useDefaultAppearance ? 'transparent' : '#fafafa'};
  box-sizing: border-box;
  height: 100%;
  width: 100%;
}

.ai-chat-messages {
  padding: 16px 15px 15px 15px;
  padding-bottom: 15px; /* Consistent padding */
  overflow-y: auto !important; /* Show scrollbar when content overflows */
  overflow-x: hidden !important;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  gap: 0 !important; /* Remove gap to use margin instead for better control */
  scroll-behavior: smooth;
  height: 100% !important; /* Take full available height */
  box-sizing: border-box !important;
  background: #fafafa; /* Light background to distinguish from header/footer */
  padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)) !important;
}

.ai-chat-messages.welcome-active {
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
  height: 100% !important;
  min-height: 0 !important;
  padding-top: 0 !important;
}

/* Custom scrollbar styling for webkit browsers */
.ai-chat-messages::-webkit-scrollbar {
  width: 8px; /* Made wider for better visibility */
}

.ai-chat-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.ai-chat-messages::-webkit-scrollbar-thumb {
  background: #bbb;
  border-radius: 4px;
}

.ai-chat-messages::-webkit-scrollbar-thumb:hover {
  background: #888;
}

/* Firefox scrollbar */
.ai-chat-messages {
  scrollbar-width: thin;
  scrollbar-color: #bbb #f1f1f1;
}

#ai-chat-messages .ai-message,
.ai-chat-messages .ai-message,
.ai-chat-messages-container .ai-message {
  max-width: 85% !important;
  width: fit-content;
  overflow: visible !important; /* Allow content to show fully */
  display: block !important;
  box-sizing: border-box !important;
  margin-bottom: 16px !important; /* Increased spacing for better visibility */
  margin-top: 0 !important; /* Reset any top margins */
}

/* Welcome screen should take full width */
.ai-welcome-message {
  max-width: 100% !important;
  width: 100% !important;
}

#ai-chat-messages .ai-message:last-child,
.ai-chat-messages .ai-message:last-child,
.ai-chat-messages-container .ai-message:last-child {
  margin-bottom: 8px !important; /* Small bottom margin for last message */
}

/* Force spacing with even higher specificity */
.ai-sales-assistant-widget .ai-chat-messages .ai-message {
  margin-bottom: 16px !important;
  margin-top: 0 !important;
}

.ai-message.user-message {
  align-self: flex-end;
}

.ai-message.assistant-message {
  align-self: flex-start;
}

.ai-message.product-recommendation {
  margin-top: 0 !important; /* Use consistent margin pattern */
  margin-bottom: 12px !important; /* Consistent with other messages */
}

.product-content {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.clickable-product {
  user-select: none;
}

.clickable-product:active {
  transform: scale(0.98) !important;
}

.message-content {
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word !important;
  word-break: break-word !important;
  overflow-wrap: break-word !important;
  hyphens: auto;
  max-width: 100% !important;
  white-space: normal !important; /* Normal whitespace handling - trim extra spaces */
  box-sizing: border-box !important;
  overflow: visible !important; /* Allow content to show fully */
}

.ai-loading {
  padding: 10px 14px;
  border-radius: 18px;
  background: #f1f1f1;
  color: #333;
  margin-bottom: 16px !important; /* Match message spacing */
  margin-top: 0 !important;
  max-width: 85% !important;
  width: fit-content;
  align-self: flex-start; /* Left-align like assistant messages */
  display: block !important;
  box-sizing: border-box !important;
}

.loading-dots {
  display: inline-flex;
  gap: 4px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--ai-primary-color, #ee5cee);
  animation: loading-bounce 1.4s ease-in-out infinite both;
}

.loading-dots span:nth-child(1) { animation-delay: -0.32s; }
.loading-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes loading-bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

.ai-chat-input {
  padding: 15px;
  border-top: none;
  position: relative;
  display: flex;
  align-items: center;
  z-index: 10; /* Keep above other content */
  height: 70px !important; /* Fixed height to prevent shifting */
  box-sizing: border-box !important;
  border-radius: 0 0 12px 12px; /* Match window border radius */
  grid-area: input !important;
}

.ai-chat-input input {
  width: 100%;
  padding: 10px 50px 10px 12px; /* Add right padding for button */
  border: 1px solid #ddd;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
  box-sizing: border-box;
}

.ai-chat-input input:focus {
  border-color: var(--ai-primary-color, #ee5cee);
}

.ai-chat-input button {
  position: absolute;
  right: 20px; /* Position inside the input */
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s;
  color: ${widgetSettings.useDefaultAppearance ? 'white' : 'var(--ai-primary-color, #ee5cee)'};
}

.ai-chat-input button:hover {
  background: ${widgetSettings.useDefaultAppearance ? 'rgba(255,255,255,0.1)' : 'rgba(238, 92, 238, 0.1)'};
}

/* Typewriter Animation for Welcome Message */
.typewriter {
  text-align: center;
  margin: 0 auto;
  word-wrap: break-word;
  border-right: 2px solid;
  animation: blink-caret 0.75s step-end infinite;
}

@keyframes blink-caret {
  from, to { 
    border-color: transparent;
  }
  50% { 
    border-color: currentColor;
  }
}

/* Remove cursor after animation */
.typewriter.typing-complete {
  border-right: none;
  animation: none;
}

/* Mobile responsiveness */
/* Product Grid Styles */
.products-grid-container {
  max-width: 100% !important;
  width: 100% !important;
}

.products-grid {
  display: grid;
  gap: 12px;
  width: 100%;
}

.product-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  height: 100%;
}

.product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.product-image {
  width: 100%;
  height: 160px;
  background-size: cover;
  background-position: center;
  background-color: #f8f9fa;
  position: relative;
  flex-shrink: 0;
}

.product-details {
  padding: 16px;
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

.product-title {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.product-price-category {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.product-price {
  font-size: 20px;
  font-weight: 700;
  color: var(--ai-primary-color, #ee5cee);
}

.product-category {
  background: #f3f4f6;
  color: #6b7280;
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 500;
}

.product-description {
  margin: 0 0 12px 0;
  font-size: 13px;
  color: #6b7280;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  flex-grow: 1;
}

.product-tags {
  margin-bottom: 12px;
}

.product-tag {
  display: inline-block;
  background: #e5e7eb;
  color: #374151;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 10px;
  margin-right: 4px;
  margin-bottom: 4px;
}

.product-action-button {
  background: var(--ai-primary-color, #ee5cee);
  color: white;
  text-align: center;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  margin-top: auto;
  transition: background-color 0.2s ease;
}

.product-action-button:hover {
  background: var(--ai-primary-color-hover, #dd44dd);
}

.relevance-badge {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--ai-primary-color, #ee5cee);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* AI Welcome Interface Styles */
.ai-welcome-container {
  width: 100%;
  max-width: none !important;
}

.ai-welcome-header {
  text-align: center;
  border-bottom: none !important;
  padding-bottom: 16px;
}

.suggestion-section {
  margin-bottom: 20px;
}

.suggestion-buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.suggestion-btn {
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px 16px;
  text-align: left;
  font-size: 14px;
  color: #374151;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
  width: 100%;
  box-sizing: border-box;
}

.suggestion-btn:hover {
  background: #e5e7eb;
  border-color: var(--ai-primary-color, #ee5cee);
  color: #111827;
  transform: translateY(-1px);
}

.suggestion-btn:active {
  transform: translateY(0);
  background: #d1d5db;
}

@media (max-width: 480px) {
  .ai-chat-window {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    height: 100dvh !important; /* Use dynamic viewport height if supported */
    border-radius: 0 !important;
    z-index: 99999 !important;
    max-height: none !important;
    min-height: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important; /* No scroll on window */
    padding-bottom: 0 !important;
  }
  .ai-chat-input {
    position: fixed !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    z-index: 10001 !important;
    border-radius: 0 !important;
    height: auto !important;
    min-height: 60px !important;
    padding: max(10px, env(safe-area-inset-bottom, 0)) 10px 10px 10px !important;
    border-top: none !important;
    display: flex !important;
    align-items: center !important;
    box-sizing: border-box !important;
    background: #fafafa !important;
  }
  .ai-chat-messages-container {
    flex: 1 1 0% !important;
    min-height: 0 !important;
    overflow: hidden !important; /* No scroll on container */
    display: flex !important;
    flex-direction: column !important;
    padding-bottom: env(safe-area-inset-bottom, 0) !important;
    position: relative !important;
    height: 100%;
    max-height: 100%;
    background: #fafafa !important;
  }
  .ai-chat-messages {
    flex: 1 1 0% !important;
    height: 100% !important;
    max-height: 100% !important;
    min-height: 0 !important;
    overflow-y: auto !important; /* Only message section scrolls */
    -webkit-overflow-scrolling: touch !important;
    box-sizing: border-box !important;
    padding: 16px 10px 10px 10px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    background: #fafafa !important;
  }
  .ai-chat-messages.welcome-active {
    padding-top: 0 !important;
  }
  .ai-chat-messages.has-messages {
    justify-content: flex-start !important;
    align-items: stretch !important;
    width: 100% !important;
  }
  .ai-welcome-header {
    border-bottom: none !important;
  }
  .ai-welcome-message {
    border-bottom: none !important;
  }
  .ai-chat-input input {
    font-size: 16px !important;
    width: 100% !important;
    padding: 10px 50px 10px 12px !important;
    box-sizing: border-box !important;
  }
  .ai-chat-input button {
    position: absolute !important;
    right: 15px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 36px !important;
    height: 36px !important;
  }
  
  /* Ensure input is always visible and properly rendered */
  .ai-chat-input {
    -webkit-transform: translateZ(0) !important;
    transform: translateZ(0) !important;
    -webkit-backface-visibility: hidden !important;
    backface-visibility: hidden !important;
  }
  
  /* FORCE REMOVE ALL BORDERS - NUCLEAR OPTION */
  .ai-sales-assistant-widget .ai-chat-input,
  .ai-sales-assistant-widget .ai-chat-input::before,
  .ai-sales-assistant-widget .ai-chat-input::after,
  .ai-chat-window .ai-chat-input,
  #ai-sales-assistant-overlay .ai-chat-input {
    border: 0px solid transparent !important;
    border-top: 0px solid transparent !important;
    border-bottom: 0px solid transparent !important;
    border-left: 0px solid transparent !important;
    border-right: 0px solid transparent !important;
    border-width: 0px !important;
    border-style: none !important;
    border-color: transparent !important;
    outline: 0px solid transparent !important;
    outline-width: 0px !important;
    outline-style: none !important;
    box-shadow: none !important;
    -webkit-box-shadow: none !important;
    -moz-box-shadow: none !important;
  }
  
  /* Also target messages container that might have borders */
  .ai-sales-assistant-widget .ai-chat-messages-container,
  .ai-sales-assistant-widget .ai-chat-messages,
  .ai-chat-window .ai-chat-messages-container,
  .ai-chat-window .ai-chat-messages {
    border-bottom: 0px solid transparent !important;
    border-bottom-width: 0px !important;
    border-bottom-style: none !important;
    border-bottom-color: transparent !important;
  }
  
}

/* Tablet responsiveness */
@media (max-width: 768px) and (min-width: 481px) {
  .products-grid {
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important;
    gap: 10px;
  }
  
  .product-image {
    height: 140px;
  }
  
  .product-title {
    font-size: 15px;
  }
  
  .product-price {
    font-size: 18px;
  }
}
    /* --- Fireworks Animation Styles --- */
    #ai-fireworks-animation {
      pointer-events: none;
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100%; height: 100%;
      z-index: 10010;
      display: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
/* Confetti Party Animation Styles */
.ai-confetti-piece {
  position: absolute;
  top: -40px;
  width: 8px;
  height: 24px;
  border-radius: 3px;
  opacity: 0.85;
  will-change: transform, opacity;
  animation: ai-confetti-fall 1.6s cubic-bezier(0.6,0.2,0.4,1) forwards;
}
@keyframes ai-confetti-fall {
  0% {
    opacity: 0.85;
    transform: translateY(0) rotateZ(var(--confetti-rotate, 0deg)) scale(1) skewX(var(--confetti-skew, 0deg));
  }
  10% {
    opacity: 1;
  }
  80% {
    opacity: 1;
    transform: translateY(80vh) rotateZ(calc(var(--confetti-rotate, 0deg) + 180deg)) scale(1) skewX(var(--confetti-skew, 0deg));
  }
  100% {
    opacity: 0;
    transform: translateY(100vh) rotateZ(calc(var(--confetti-rotate, 0deg) + 360deg)) scale(0.9) skewX(var(--confetti-skew, 0deg));
  }
}

/* Theme-aware mobile background overrides */
${widgetSettings.useDefaultAppearance ? `
@media (max-width: 480px) {
  .ai-chat-input {
    background: rgba(0, 0, 0, 0.2) !important;
    backdrop-filter: blur(12px) !important;
  }
  .ai-chat-messages-container {
    background: rgba(0, 0, 0, 0.2) !important;
    backdrop-filter: blur(12px) !important;
  }
  .ai-chat-messages {
    background: transparent !important;
  }
}
` : ''}
    `;
    
    // Debug: Log the generated CSS
    console.log('🎨 AI Widget: Generated CSS:', style.textContent.substring(style.textContent.length - 500));
    console.log('🎨 AI Widget: Default appearance styles applied:', widgetSettings.useDefaultAppearance);
    
    document.head.appendChild(style);
  }
  
  // Setup event listeners for widget buttons
  function setupEventListeners() {
    console.log('🔧 AI Widget: Setting up event listeners');
    
    // Store references to event handlers so we can remove them if needed
    window.aiWidgetHandlers = window.aiWidgetHandlers || {};
    
    // Toggle button event listener
    const toggleBtn = document.getElementById('ai-chat-toggle-btn');
    if (toggleBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.toggleHandler) {
        toggleBtn.removeEventListener('click', window.aiWidgetHandlers.toggleHandler);
      }
      
      window.aiWidgetHandlers.toggleHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('🖱️ AI Widget: Toggle button clicked');
        toggleAIChat();
      };
      
      toggleBtn.addEventListener('click', window.aiWidgetHandlers.toggleHandler);
      console.log('✅ AI Widget: Toggle button event listener added');
    } else {
      console.warn('⚠️ AI Widget: Toggle button not found');
    }
    
    // Close button event listener
    const closeBtn = document.getElementById('ai-chat-close-btn');
    if (closeBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.closeHandler) {
        closeBtn.removeEventListener('click', window.aiWidgetHandlers.closeHandler);
      }
      
      window.aiWidgetHandlers.closeHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('🖱️ AI Widget: Close button clicked');
        toggleAIChat();
      };
      
      closeBtn.addEventListener('click', window.aiWidgetHandlers.closeHandler);
      console.log('✅ AI Widget: Close button event listener added');
    } else {
      console.warn('⚠️ AI Widget: Close button not found');
    }
    
    // Call button event listener
    const callBtn = document.getElementById('ai-chat-call-btn');
    if (callBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.callHandler) {
        callBtn.removeEventListener('click', window.aiWidgetHandlers.callHandler);
      }
      
      window.aiWidgetHandlers.callHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('📞 AI Widget: Call button clicked');
        // You can customize this behavior - for now, it could open a contact form, phone dialer, or booking system
        alert('Call functionality - customize this to your needs!');
      };
      
      callBtn.addEventListener('click', window.aiWidgetHandlers.callHandler);
      console.log('✅ AI Widget: Call button event listener added');
    } else {
      console.warn('⚠️ AI Widget: Call button not found');
    }
    
    // Send button event listener
    const sendBtn = document.getElementById('ai-chat-send-btn');
    if (sendBtn) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.sendHandler) {
        sendBtn.removeEventListener('click', window.aiWidgetHandlers.sendHandler);
      }
      
      window.aiWidgetHandlers.sendHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        sendAIMessage();
      };
      
      sendBtn.addEventListener('click', window.aiWidgetHandlers.sendHandler);
      console.log('✅ AI Widget: Send button event listener added');
    } else {
      console.warn('⚠️ AI Widget: Send button not found');
    }
    
    // Input field event listener for Enter key
    const inputField = document.getElementById('ai-chat-input-field');
    if (inputField) {
      // Remove existing listener if any
      if (window.aiWidgetHandlers.keyHandler) {
        inputField.removeEventListener('keypress', window.aiWidgetHandlers.keyHandler);
      }
      
      window.aiWidgetHandlers.keyHandler = function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendAIMessage();
        }
      };
      
      inputField.addEventListener('keypress', window.aiWidgetHandlers.keyHandler);
      console.log('✅ AI Widget: Input field event listener added');
    } else {
      console.warn('⚠️ AI Widget: Input field not found');
    }
    
    // Add suggestion button event listeners
    const suggestionBtns = document.querySelectorAll('.suggestion-btn');
    suggestionBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const prompt = this.getAttribute('data-prompt');
        if (prompt) {
          console.log('🖱️ AI Widget: Suggestion clicked:', prompt);
          // Auto-fill input and send message
          const inputField = document.getElementById('ai-chat-input-field');
          if (inputField) {
            inputField.value = prompt;
            sendAIMessage();
          }
        }
      });
    });
    console.log('✅ AI Widget: Suggestion button listeners added:', suggestionBtns.length);
    
    // Remove click outside to close functionality
    // (No document.addEventListener for outsideClickHandler)
  }
  
  // Add manual refresh function for debugging
  window.refreshAIWidget = async function() {
    console.log('🔄 AI Widget: Manual refresh triggered');
    await initializeWidget();
  };
  
  // Debug function to inspect mobile styling
  window.debugAIMobile = function() {
    const elements = {
      chatWindow: document.getElementById('ai-chat-window'),
      messagesContainer: document.querySelector('.ai-chat-messages-container'),
      messages: document.getElementById('ai-chat-messages'),
      input: document.querySelector('.ai-chat-input')
    };
    
    console.log('🔍 AI Widget Debug - Current state:', {
      widgetSettings: widgetSettings,
      screenWidth: window.innerWidth,
      isMobile: window.innerWidth <= 480
    });
    
    Object.entries(elements).forEach(([name, el]) => {
      if (el) {
        const styles = window.getComputedStyle(el);
        console.log(`🔍 ${name}:`, {
          background: styles.background,
          backgroundColor: styles.backgroundColor,
          backdropFilter: styles.backdropFilter,
          borderTop: styles.borderTop,
          padding: styles.padding,
          position: styles.position
        });
      } else {
        console.log(`🔍 ${name}: Element not found`);
      }
    });
    
    // Visual indicator for theme detection
    if (elements.chatWindow) {
      const indicator = document.createElement('div');
      indicator.style.cssText = `
        position: fixed; top: 10px; left: 10px; z-index: 99999; 
        background: red; color: white; padding: 5px; font-size: 12px;
        border-radius: 3px; pointer-events: none;
      `;
      indicator.textContent = `Theme: ${widgetSettings?.useDefaultAppearance ? 'DEFAULT' : 'CUSTOM'} | Mobile: ${window.innerWidth <= 480}`;
      document.body.appendChild(indicator);
      setTimeout(() => indicator.remove(), 5000);
    }
  };
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWidget);
  } else {
    initializeWidget();
  }
  
  // Check for setting updates every 5 minutes (reduced from 2 seconds to prevent excessive database queries)
  let workingApiUrl = null; // Cache the working URL to avoid testing all URLs every time
  
  setInterval(async () => {
    try {
      const shopDomain = window.Shopify?.shop || '{{ shop.permanent_domain }}';
      const urlsToTry = workingApiUrl ? [workingApiUrl] : [
        // Use app proxy URL - properly forwarded to your app server
        '{{ shop.url }}' + '/apps/widget-settings',
        // Fallback to current host
        window.location.protocol + '//' + window.location.host + '/apps/widget-settings'
      ];
      
      for (const url of urlsToTry) {
        try {
          const response = await fetch(`${url}?shop=${shopDomain}&t=${Date.now()}`);
          if (response.ok) {
            const data = await response.json();
            const currentUpdate = data.settings.updatedAt;
            
            // Cache the working URL
            if (!workingApiUrl) workingApiUrl = url;
            
            if (window.lastSettingsUpdate && currentUpdate !== window.lastSettingsUpdate) {
              console.log('🔄 AI Widget: Settings updated, refreshing widget...', {
                old: window.lastSettingsUpdate,
                new: currentUpdate,
                newSettings: data.settings
              });
              widgetSettings = { ...blockSettings, ...data.settings };
              createWidget();
              console.log('✅ AI Widget: Widget refreshed with new settings');
            }
            window.lastSettingsUpdate = currentUpdate;
            break; // Success, stop trying other URLs
          }
        } catch (e) {
          // If the cached URL fails, reset it to try all URLs next time
          if (url === workingApiUrl) workingApiUrl = null;
          continue;
        }
      }
    } catch (e) {
      // Silently fail
    }
  }, 300000); // 5 minutes (300,000ms) - much more reasonable for production
})();

// Prevent iOS zoom on input focus by managing viewport meta tag
let aiViewportMeta = null;
function addAIViewportMeta() {
  if (!aiViewportMeta) {
    aiViewportMeta = document.createElement('meta');
    aiViewportMeta.name = 'viewport';
    aiViewportMeta.content = 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0';
    document.head.appendChild(aiViewportMeta);
  }
}
function removeAIViewportMeta() {
  if (aiViewportMeta && aiViewportMeta.parentNode) {
    aiViewportMeta.parentNode.removeChild(aiViewportMeta);
    aiViewportMeta = null;
  }
}
// Hook into chat open/close
const origToggleAIChat = window.toggleAIChat;
window.toggleAIChat = function() {
  origToggleAIChat.apply(this, arguments);
  const chatWindow = document.getElementById('ai-chat-window');
  const overlay = document.getElementById('ai-sales-assistant-overlay');
  const isMobile = window.innerWidth <= 480;
  
  if (chatWindow && chatWindow.classList.contains('ai-chat-open')) {
    // Only prevent body scrolling on mobile devices
    if (isMobile) {
      document.body.style.overflow = 'hidden';
    }
    if (overlay) overlay.style.display = 'block';
    setTimeout(adjustMessageAreaHeight, 50);
  } else {
    // Always restore body scrolling when chat closes
    document.body.style.overflow = '';
    if (overlay) overlay.style.display = 'none';
  }
};
function adjustMessageAreaHeight() {
  const chatWindow = document.getElementById('ai-chat-window');
  const header = chatWindow?.querySelector('.ai-chat-header');
  const input = chatWindow?.querySelector('.ai-chat-input');
  const messagesContainer = chatWindow?.querySelector('.ai-chat-messages');
  if (chatWindow && header && input && messagesContainer) {
    const winH = window.innerHeight;
    const headerH = header.offsetHeight;
    const inputH = input.offsetHeight;
    const safeInset = parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)') || '0', 10);
    const msgH = winH - headerH - inputH - safeInset;
    messagesContainer.style.height = msgH + 'px';
    messagesContainer.style.maxHeight = msgH + 'px';
    messagesContainer.style.paddingBottom = '0px';
  }
}
window.addEventListener('resize', adjustMessageAreaHeight);
window.addEventListener('orientationchange', adjustMessageAreaHeight);
// Also call after chat is initialized
setTimeout(adjustMessageAreaHeight, 200);
// After every image in a message loads, scroll to bottom
function observeImagesForScroll() {
  const messagesContainer = document.getElementById('ai-chat-messages');
  if (!messagesContainer) return;
  const imgs = messagesContainer.querySelectorAll('img');
  imgs.forEach(img => {
    img.addEventListener('load', () => setTimeout(scrollToBottom, 50));
  });
}
// Call after adding product cards or messages
// Scroll input into view on focus (for mobile)
document.addEventListener('focusin', function(e) {
  if (e.target && e.target.id === 'ai-chat-input-field') {
    setTimeout(function() {
      e.target.scrollIntoView({block: 'end', behavior: 'smooth'});
    }, 100);
  }
});

// Use MutationObserver to auto-scroll to bottom when messages change
(function() {
  const messagesContainer = document.getElementById('ai-chat-messages');
  if (messagesContainer) {
    const observer = new MutationObserver(() => {
      setTimeout(scrollToBottom, 50);
    });
    observer.observe(messagesContainer, { childList: true, subtree: true });
  }
})();

// --- Fireworks Animation Logic ---
function triggerFireworksAnimation() {
  console.log('[AI Widget] triggerFireworksAnimation (confetti) called');
  const fireworks = document.getElementById('ai-fireworks-animation');
  if (!fireworks) { console.log('[AI Widget] Fireworks overlay not found!'); return; }
  // Remove any previous confetti
  fireworks.innerHTML = '';
  fireworks.style.display = 'block';
  // Force reflow for transition
  void fireworks.offsetWidth;
  fireworks.style.opacity = '1';
  // Confetti colors
  const confettiColors = [
    '#ee5cee', '#31d1d1', '#ffd700', '#ff5c5c', '#4caf50', '#2196f3', '#ff9800', '#9c27b0', '#e91e63', '#00bcd4', '#fff', '#f44336', '#8bc34a', '#ffeb3b', '#3f51b5', '#ffb300'
  ];
  // Create 35 confetti pieces
  for (let i = 0; i < 35; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'ai-confetti-piece';
    // Random color
    confetti.style.background = confettiColors[Math.floor(Math.random() * confettiColors.length)];
    // Random left position (5% to 95%)
    confetti.style.left = (5 + Math.random() * 90) + '%';
    // Random width/height
    const w = 6 + Math.random() * 8;
    const h = 16 + Math.random() * 18;
    confetti.style.width = w + 'px';
    confetti.style.height = h + 'px';
    // Random rotation and skew
    confetti.style.setProperty('--confetti-rotate', Math.floor(Math.random() * 360) + 'deg');
    confetti.style.setProperty('--confetti-skew', (Math.random() * 30 - 15) + 'deg');
    // Random animation delay (0-0.7s)
    confetti.style.animationDelay = (Math.random() * 0.7) + 's';
    // Random border radius for more variety
    confetti.style.borderRadius = (2 + Math.random() * 5) + 'px';
    fireworks.appendChild(confetti);
  }
  // Hide after 2.2s
  setTimeout(() => {
    fireworks.style.opacity = '0';
    setTimeout(() => {
      fireworks.style.display = 'none';
      fireworks.innerHTML = '';
    }, 350); // allow transition to finish
  }, 2200);
}
</script> 